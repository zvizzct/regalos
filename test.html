<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tests - Amigo Secreto</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            color: #eee;
            padding: 2rem;
            min-height: 100vh;
        }
        h1 {
            color: #ffd700;
            margin-bottom: 1rem;
        }
        h2 {
            color: #00a8ff;
            margin: 2rem 0 1rem;
            border-bottom: 1px solid #333;
            padding-bottom: 0.5rem;
        }
        .test-controls {
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        button {
            padding: 1rem 2rem;
            font-size: 1rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: #ffd700;
            color: #1a1a2e;
            font-weight: bold;
        }
        .btn-primary:hover {
            background: #ffed4a;
            transform: scale(1.05);
        }
        .btn-secondary {
            background: #333;
            color: #fff;
        }
        .btn-secondary:hover {
            background: #444;
        }
        .test-result {
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .test-result.pass {
            background: rgba(0, 255, 0, 0.1);
            border-left: 4px solid #00ff00;
        }
        .test-result.fail {
            background: rgba(255, 0, 0, 0.1);
            border-left: 4px solid #ff0000;
        }
        .test-result .icon {
            font-size: 1.5rem;
        }
        .test-result .details {
            font-size: 0.85rem;
            color: #999;
            margin-top: 0.25rem;
        }
        .summary {
            background: #222;
            padding: 1.5rem;
            border-radius: 10px;
            margin: 2rem 0;
        }
        .summary h3 {
            margin-bottom: 1rem;
        }
        .summary .stats {
            display: flex;
            gap: 2rem;
        }
        .summary .stat {
            text-align: center;
        }
        .summary .stat .number {
            font-size: 2rem;
            font-weight: bold;
        }
        .summary .stat.pass .number { color: #00ff00; }
        .summary .stat.fail .number { color: #ff0000; }
        .summary .stat.total .number { color: #ffd700; }
        .log-container {
            background: #111;
            border-radius: 10px;
            padding: 1rem;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.85rem;
        }
        .log-entry {
            padding: 0.25rem 0;
            border-bottom: 1px solid #222;
        }
        .log-entry.error { color: #ff6b6b; }
        .log-entry.success { color: #69db7c; }
        .log-entry.info { color: #74c0fc; }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin: 1rem 0;
        }
        .progress-bar .fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff00, #ffd700);
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <h1>üß™ Tests - Amigo Secreto</h1>
    <p style="margin-bottom: 1rem; opacity: 0.7;">Verificaci√≥n de que el sistema de sorteo funciona correctamente</p>

    <div class="test-controls">
        <button class="btn-primary" onclick="runAllTests()">‚ñ∂Ô∏è Ejecutar Todos los Tests</button>
        <button class="btn-secondary" onclick="runStressTest()">üî• Stress Test (100 sorteos)</button>
        <button class="btn-secondary" onclick="clearResults()">üóëÔ∏è Limpiar</button>
    </div>

    <div class="progress-bar" id="progress-bar" style="display: none;">
        <div class="fill" id="progress-fill" style="width: 0%"></div>
    </div>

    <div class="summary" id="summary" style="display: none;">
        <h3>üìä Resumen</h3>
        <div class="stats">
            <div class="stat pass">
                <div class="number" id="pass-count">0</div>
                <div class="label">Pasados</div>
            </div>
            <div class="stat fail">
                <div class="number" id="fail-count">0</div>
                <div class="label">Fallidos</div>
            </div>
            <div class="stat total">
                <div class="number" id="total-count">0</div>
                <div class="label">Total</div>
            </div>
        </div>
    </div>

    <div id="test-results"></div>

    <h2>üìã Log de Ejecuci√≥n</h2>
    <div class="log-container" id="log-container"></div>

    <script>
        // ========== COPIAR L√ìGICA DEL SORTEO ==========

        const participants = {
            spain: ['Yolimar', 'V√≠ctor', 'Paola', 'Geral', 'Vanesa', 'Edimar', 'Pedro'],
            venezuela: [
                '√Ångel', 'Carolina y Dylan', 'Daylin', 'Elodia', 'Fanny', 'Jennifer',
                'Junior y Sim√≥n', 'Maril√≠n', 'Miriam', 'Robert', 'Romer', 'Roswell',
                'Royer y Dereck', 'Santiago'
            ]
        };

        const complices = {
            'Paola': 'Yolimar',
            'Yolimar': 'V√≠ctor',
            'V√≠ctor': 'Paola',
            'Vanesa': 'Geral',
            'Geral': 'Vanesa',
            'Edimar': 'Pedro',
            'Pedro': 'Edimar'
        };

        function shuffle(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function tryGenerateAssignments(spain, venezuela) {
            const assignments = {};
            const receivers = new Set();

            // 1. Asignar espa√±oles -> venezolanos
            const shuffledVenezuelaForSpain = shuffle(venezuela);
            for (let i = 0; i < spain.length; i++) {
                const giver = spain[i];
                let assigned = false;
                for (const receiver of shuffledVenezuelaForSpain) {
                    if (receivers.has(receiver)) continue;
                    assignments[giver] = {
                        giver, giverCountry: 'spain',
                        receiver, receiverCountry: 'venezuela',
                        complice: null
                    };
                    receivers.add(receiver);
                    assigned = true;
                    break;
                }
                if (!assigned) return null;
            }

            // 2. Asignar venezolanos
            const venezuelansNotReceiving = venezuela.filter(v => !receivers.has(v));
            const allReceiversForVenezuelans = shuffle([...spain, ...venezuelansNotReceiving]);
            const shuffledVenezuelansGivers = shuffle(venezuela);

            for (const giver of shuffledVenezuelansGivers) {
                let assigned = false;
                for (const receiver of allReceiversForVenezuelans) {
                    if (receivers.has(receiver)) continue;
                    if (receiver === giver) continue;

                    const receiverCountry = spain.includes(receiver) ? 'spain' : 'venezuela';

                    if (receiverCountry === 'spain') {
                        const compliceName = complices[receiver];
                        if (assignments[compliceName] && assignments[compliceName].receiver === giver) {
                            continue;
                        }
                    }

                    if (assignments[receiver] && assignments[receiver].receiver === giver) {
                        continue;
                    }

                    assignments[giver] = {
                        giver, giverCountry: 'venezuela',
                        receiver, receiverCountry,
                        complice: receiverCountry === 'spain' ? complices[receiver] : null
                    };
                    receivers.add(receiver);
                    assigned = true;
                    break;
                }
                if (!assigned) return null;
            }

            // Verificar espa√±oles reciben
            const spanishReceiving = new Set(
                Object.values(assignments)
                    .filter(a => a.receiverCountry === 'spain')
                    .map(a => a.receiver)
            );
            if (spanishReceiving.size !== spain.length) return null;

            // Verificaci√≥n final
            for (const [giver, assignment] of Object.entries(assignments)) {
                if (assignment.receiverCountry === 'spain') {
                    const compliceName = complices[assignment.receiver];
                    if (assignments[compliceName] && assignments[compliceName].receiver === giver) {
                        return null;
                    }
                }
            }

            return assignments;
        }

        function realizarSorteo() {
            const spain = [...participants.spain];
            const venezuela = [...participants.venezuela];
            let assignments = null;
            let attempts = 0;
            const maxAttempts = 5000;

            while (!assignments && attempts < maxAttempts) {
                attempts++;
                assignments = tryGenerateAssignments(spain, venezuela);
            }

            return { assignments, attempts };
        }

        // ========== FUNCIONES DE TEST ==========

        let testResults = [];
        let logEntries = [];

        function log(message, type = 'info') {
            logEntries.push({ message, type, time: new Date().toLocaleTimeString() });
            renderLog();
        }

        function renderLog() {
            const container = document.getElementById('log-container');
            container.innerHTML = logEntries.map(entry =>
                `<div class="log-entry ${entry.type}">[${entry.time}] ${entry.message}</div>`
            ).join('');
            container.scrollTop = container.scrollHeight;
        }

        function addTestResult(name, passed, details = '') {
            testResults.push({ name, passed, details });
            renderResults();
        }

        function renderResults() {
            const container = document.getElementById('test-results');
            container.innerHTML = testResults.map(result => `
                <div class="test-result ${result.passed ? 'pass' : 'fail'}">
                    <span class="icon">${result.passed ? '‚úÖ' : '‚ùå'}</span>
                    <div>
                        <strong>${result.name}</strong>
                        ${result.details ? `<div class="details">${result.details}</div>` : ''}
                    </div>
                </div>
            `).join('');

            // Actualizar resumen
            const passed = testResults.filter(r => r.passed).length;
            const failed = testResults.filter(r => !r.passed).length;
            document.getElementById('pass-count').textContent = passed;
            document.getElementById('fail-count').textContent = failed;
            document.getElementById('total-count').textContent = testResults.length;
            document.getElementById('summary').style.display = 'block';
        }

        function clearResults() {
            testResults = [];
            logEntries = [];
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('log-container').innerHTML = '';
            document.getElementById('summary').style.display = 'none';
        }

        // ========== TESTS ==========

        function runAllTests() {
            clearResults();
            log('üöÄ Iniciando tests...', 'info');

            const { assignments, attempts } = realizarSorteo();

            if (!assignments) {
                addTestResult('Sorteo genera asignaciones', false, 'No se pudo generar sorteo');
                log('‚ùå Sorteo fall√≥', 'error');
                return;
            }

            log(`‚úÖ Sorteo completado en ${attempts} intentos`, 'success');

            // Test 1: Sorteo genera asignaciones
            addTestResult(
                'Sorteo genera asignaciones v√°lidas',
                assignments !== null,
                `Completado en ${attempts} intentos`
            );

            // Test 2: Todos los participantes dan regalo
            const allParticipants = [...participants.spain, ...participants.venezuela];
            const givers = Object.keys(assignments);
            const allGive = allParticipants.every(p => givers.includes(p));
            addTestResult(
                'Todos los participantes dan un regalo',
                allGive,
                `${givers.length}/${allParticipants.length} participantes`
            );

            // Test 3: Todos reciben exactamente un regalo
            const receiversList = Object.values(assignments).map(a => a.receiver);
            const uniqueReceivers = new Set(receiversList);
            const allReceiveOnce = uniqueReceivers.size === allParticipants.length;
            addTestResult(
                'Todos reciben exactamente un regalo',
                allReceiveOnce,
                `${uniqueReceivers.size} receptores √∫nicos de ${allParticipants.length}`
            );

            // Test 4: Nadie se regala a s√≠ mismo
            const noSelfGift = Object.values(assignments).every(a => a.giver !== a.receiver);
            addTestResult(
                'Nadie se regala a s√≠ mismo',
                noSelfGift,
                noSelfGift ? 'Sin auto-regalos' : 'Encontrado auto-regalo!'
            );

            // Test 5: Espa√±oles solo regalan a venezolanos
            const spanishAssignments = Object.values(assignments).filter(a => a.giverCountry === 'spain');
            const spanishOnlyToVenezuela = spanishAssignments.every(a => a.receiverCountry === 'venezuela');
            addTestResult(
                'Espa√±oles solo regalan a venezolanos',
                spanishOnlyToVenezuela,
                `${spanishAssignments.length} asignaciones de Espa√±a`
            );

            // Test 6: Todos los espa√±oles reciben regalo
            const spanishReceivers = Object.values(assignments)
                .filter(a => a.receiverCountry === 'spain')
                .map(a => a.receiver);
            const allSpanishReceive = participants.spain.every(s => spanishReceivers.includes(s));
            addTestResult(
                'Todos los espa√±oles reciben regalo',
                allSpanishReceive,
                `${spanishReceivers.length}/${participants.spain.length} espa√±oles reciben`
            );

            // Test 7: Restricci√≥n de c√≥mplice (el c√≥mplice no regala a quien le pide ayuda)
            let complicePassed = true;
            let compliceDetails = '';
            for (const [giver, assignment] of Object.entries(assignments)) {
                if (assignment.receiverCountry === 'spain') {
                    const compliceName = complices[assignment.receiver];
                    if (assignments[compliceName] && assignments[compliceName].receiver === giver) {
                        complicePassed = false;
                        compliceDetails = `${giver} regala a ${assignment.receiver}, pero ${compliceName} (c√≥mplice) regala a ${giver}`;
                        break;
                    }
                }
            }
            addTestResult(
                'Restricci√≥n de c√≥mplice se cumple',
                complicePassed,
                complicePassed ? 'Ning√∫n conflicto de c√≥mplice' : compliceDetails
            );

            // Test 8: No hay ciclos de 2 (A->B y B->A)
            let noCycles = true;
            let cycleDetails = '';
            for (const [giver, assignment] of Object.entries(assignments)) {
                const receiver = assignment.receiver;
                if (assignments[receiver] && assignments[receiver].receiver === giver) {
                    noCycles = false;
                    cycleDetails = `Ciclo encontrado: ${giver} ‚Üî ${receiver}`;
                    break;
                }
            }
            addTestResult(
                'No hay ciclos de 2 personas',
                noCycles,
                noCycles ? 'Sin ciclos directos' : cycleDetails
            );

            // Test 9: C√≥mplices asignados correctamente
            const venezuelaToSpain = Object.values(assignments).filter(
                a => a.giverCountry === 'venezuela' && a.receiverCountry === 'spain'
            );
            const allHaveComplice = venezuelaToSpain.every(a => a.complice && complices[a.receiver] === a.complice);
            addTestResult(
                'C√≥mplices asignados correctamente',
                allHaveComplice,
                `${venezuelaToSpain.length} asignaciones VEN‚ÜíESP con c√≥mplice`
            );

            // Test 10: Codificaci√≥n/Decodificaci√≥n de enlaces
            const testAssignment = Object.values(assignments)[0];
            const data = {
                giver: testAssignment.giver,
                receiver: testAssignment.receiver,
                complice: testAssignment.complice,
                giverCountry: testAssignment.giverCountry,
                receiverCountry: testAssignment.receiverCountry
            };
            const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(data))));
            const decoded = JSON.parse(decodeURIComponent(escape(atob(encoded))));
            const encodingWorks = decoded.giver === data.giver && decoded.receiver === data.receiver;
            addTestResult(
                'Codificaci√≥n/Decodificaci√≥n de enlaces',
                encodingWorks,
                encodingWorks ? 'Base64 funciona correctamente' : 'Error en codificaci√≥n'
            );

            log('‚úÖ Tests completados', 'success');

            // Mostrar asignaciones en log
            log('--- ASIGNACIONES GENERADAS ---', 'info');
            Object.values(assignments).forEach(a => {
                const compliceInfo = a.complice ? ` (c√≥mplice: ${a.complice})` : '';
                log(`${a.giver} ‚Üí ${a.receiver}${compliceInfo}`, 'info');
            });
        }

        async function runStressTest() {
            clearResults();
            log('üî• Iniciando Stress Test (100 sorteos)...', 'info');

            document.getElementById('progress-bar').style.display = 'block';
            const progressFill = document.getElementById('progress-fill');

            let successful = 0;
            let failed = 0;
            let totalAttempts = 0;
            let maxAttempts = 0;
            let minAttempts = Infinity;

            for (let i = 0; i < 100; i++) {
                // Actualizar progreso
                progressFill.style.width = `${i + 1}%`;

                const { assignments, attempts } = realizarSorteo();

                if (assignments) {
                    successful++;
                    totalAttempts += attempts;
                    maxAttempts = Math.max(maxAttempts, attempts);
                    minAttempts = Math.min(minAttempts, attempts);

                    // Verificar restricciones
                    let valid = true;

                    // Verificar restricci√≥n de c√≥mplice
                    for (const [giver, assignment] of Object.entries(assignments)) {
                        if (assignment.receiverCountry === 'spain') {
                            const compliceName = complices[assignment.receiver];
                            if (assignments[compliceName] && assignments[compliceName].receiver === giver) {
                                valid = false;
                                log(`‚ùå Sorteo ${i+1}: Conflicto c√≥mplice - ${giver}/${assignment.receiver}/${compliceName}`, 'error');
                                break;
                            }
                        }
                    }

                    // Verificar ciclos
                    for (const [giver, assignment] of Object.entries(assignments)) {
                        if (assignments[assignment.receiver] && assignments[assignment.receiver].receiver === giver) {
                            valid = false;
                            log(`‚ùå Sorteo ${i+1}: Ciclo - ${giver} ‚Üî ${assignment.receiver}`, 'error');
                            break;
                        }
                    }

                    if (!valid) {
                        failed++;
                        successful--;
                    }
                } else {
                    failed++;
                    log(`‚ùå Sorteo ${i+1}: No se pudo generar`, 'error');
                }

                // Peque√±a pausa para actualizar UI
                if (i % 10 === 0) {
                    await new Promise(r => setTimeout(r, 10));
                }
            }

            document.getElementById('progress-bar').style.display = 'none';

            // Resultados
            addTestResult(
                'Stress Test: Sorteos exitosos',
                successful === 100,
                `${successful}/100 sorteos v√°lidos`
            );

            addTestResult(
                'Stress Test: Sin fallos de restricciones',
                failed === 0,
                failed === 0 ? 'Todas las restricciones cumplidas' : `${failed} sorteos con problemas`
            );

            const avgAttempts = Math.round(totalAttempts / successful);
            addTestResult(
                'Stress Test: Eficiencia del algoritmo',
                avgAttempts < 100,
                `Promedio: ${avgAttempts} intentos, Min: ${minAttempts}, Max: ${maxAttempts}`
            );

            log(`üìä Resultados: ${successful}/100 exitosos, Promedio ${avgAttempts} intentos`, 'success');
        }
    </script>
</body>
</html>
